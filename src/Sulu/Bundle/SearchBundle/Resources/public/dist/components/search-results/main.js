define(["text!sulusearch/components/search-results/main.html","text!sulusearch/components/search-results/search-results.html"],function(a,b){"use strict";var c={instanceName:"",searchUrl:"/admin/search",enabledCategoriesUrl:"/admin/search/categories"},d=function(a){return"sulu.search-results."+(this.options.instanceName?this.options.instanceName+".":"")+a},e=function(){return d.call(this,"initialized")};return{initialize:function(){this.options=this.sandbox.util.extend(!0,{},c,this.options),this.mainTpl=this.sandbox.util.template(a),this.searchResultsTpl=this.sandbox.util.template(b),this.dropDownEntries=[],this.enabledCategories=[],this.categoriesStore={},this.totals={},this.state={page:1,pageCount:1,loading:!1,hasNextPage:!0,category:"all",query:""},this.setCategories(),this.loadCategories().then(function(){this.render(),this.startInfiniteScroll(),this.bindEvents(),this.bindDOMEvents(),this.sandbox.emit(e.call(this))}.bind(this))},bindEvents:function(){this.sandbox.on("sulu.dropdown-input."+this.dropDownInputInstance+".action",this.dropDownInputActionHandler.bind(this)),this.sandbox.on("sulu.dropdown-input."+this.dropDownInputInstance+".clear",this.dropDownInputClearHandler.bind(this)),this.sandbox.on("sulu.dropdown-input."+this.dropDownInputInstance+".change",this.dropDownInputActionHandler.bind(this))},bindDOMEvents:function(){this.$el.on("click",".search-results-section li",this.openSearchEntry.bind(this))},render:function(){var a=this.mainTpl();this.$el.html(a),this.createSearchInput()},startInfiniteScroll:function(){var a=this.$el.find(".iscroll");this.sandbox.infiniteScroll(a,this.loadNextPage.bind(this),50)},setCategories:function(){this.categories={all:{id:"all",name:this.sandbox.translate("search-overlay.category.everything.title"),placeholder:this.sandbox.translate("search-overlay.placeholder.everything")},media:{id:"media",name:this.sandbox.translate("search-overlay.category.media.title"),placeholder:this.sandbox.translate("search-overlay.placeholder.media")},contact:{id:"contact",name:this.sandbox.translate("search-overlay.category.contacts.title"),placeholder:this.sandbox.translate("search-overlay.placeholder.contacts")},account:{id:"account",name:this.sandbox.translate("search-overlay.category.accounts.title"),placeholder:this.sandbox.translate("search-overlay.placeholder.accounts")},page:{id:"page",name:this.sandbox.translate("search-overlay.category.pages.title"),placeholder:this.sandbox.translate("search-overlay.placeholder.pages")},snippet:{id:"snippet",name:this.sandbox.translate("search-overlay.category.snippet.title"),placeholder:this.sandbox.translate("search-overlay.placeholder.snippet")}}},loadCategories:function(){return this.sandbox.util.load(this.options.enabledCategoriesUrl).then(function(a){var b;this.enabledCategories.push(this.categories.all),a.forEach(function(a){b=this.categories[a],this.enabledCategories.push(b)}.bind(this))}.bind(this))},createSearchInput:function(){this.dropDownInputInstance="searchResults",this.sandbox.start([{name:"dropdown-input@sulusearch",options:{el:this.$el.find(".search-results-bar"),instanceName:this.dropDownInputInstance,preSelectedElement:"all",data:this.enabledCategories}}])},load:function(){var a=this.options.searchUrl+"/query?q="+this.state.query+"&page="+this.state.page,b=this.state.category;return b&&"all"!==b&&(a+="&category="+b),this.sandbox.util.load(a).then(this.parse.bind(this))},loadNextPage:function(){var a=this.sandbox.data.deferred();return this.state.hasNextPage&&!this.state.loading?(this.startLoader(),this.state.page++,this.load().then(this.mergeResults.bind(this)).then(this.updateResults.bind(this))):(a.resolve(),a)},parse:function(a){var b,c,d=a.result||[],e={};return this.state.page=a.page,this.state.pageCount=a.pageCount,this.state.loading=!1,this.state.hasNextPage=a.page<a.page_count,this.totals=a.totals,d.forEach(function(a){b=a.document.category,c=this.getEntryDeepUrl(b,a.document),a.document.deepUrl=c,e[b]?e[b].results.push(a.document):e[b]={category:b,results:[a.document]}}.bind(this)),e},mergeResults:function(a){return a&&Object.keys(a).forEach(function(b){this.categoriesStore[b]?this.categoriesStore[b].results=this.categoriesStore[b].results.concat(a[b].results):this.categoriesStore[b]=a[b]}.bind(this)),this.categoriesStore},dropDownInputActionHandler:function(a){a.value&&(this.state.query=a.value,this.state.category=a.selectedElement,this.state.page=1,this.categoriesStore={},this.startLoader(),this.updateResults(),this.load().then(function(a){this.categoriesStore=a,this.updateResults(a)}.bind(this)))},dropDownInputClearHandler:function(){this.updateResults()},getEntryDeepUrl:function(a,b){var c=this.urlTemplateMapping[a],d=null;return c&&(d=c.call(this,b)),d},urlTemplateMapping:{page:function(a){return"/"===a.url?this.sandbox.urlManager.getUrl("startpage",{id:a.id,webspace:a.properties.webspace_key}):this.sandbox.urlManager.getUrl("contentDetail",{id:a.id,webspace:a.properties.webspace_key})},contact:function(a){return this.sandbox.urlManager.getUrl("contactDetail",a)},account:function(a){return this.sandbox.urlManager.getUrl("accountDetail",a)},media:function(a){return this.sandbox.urlManager.getUrl("mediaDetail",{id:a.id,collectionId:a.properties.collection_id})},snippet:function(a){return this.sandbox.urlManager.getUrl("snippetDetail",a)}},categoryIconMapping:{contact:"fa-user",page:"fa-file-o",snippet:"fa-file",account:"fa-university"},getTemplate:function(a){var b=[];return a&&Object.keys(a).forEach(function(c){b.push(a[c])}.bind(this)),this.searchResultsTpl({sections:b,categories:this.categories,totals:this.totals,categoryIconMapping:this.categoryIconMapping,translate:this.sandbox.translate})},updateResults:function(a){var b=this.getTemplate(a);this.stopLoader(),this.$el.find(".search-results").html(b)},openSearchEntry:function(a){var b=$(a.currentTarget),c=b.data("url");c&&(this.sandbox.emit("sulu.router.navigate",c),this.sandbox.emit("sulu.data-overlay.hide"))},startLoader:function(){var a=this.sandbox.dom.createElement('<div class="search-results-loader"/>');this.sandbox.dom.append(this.$el.find(".search-results-loader-container"),a),this.sandbox.start([{name:"loader@husky",options:{el:a,size:"100px",color:"#ccc"}}])},stopLoader:function(){this.sandbox.stop(".search-results-loader")}}});