define([],function(){"use strict";var a=0,b=1,c=2,d=3,e=4,f=5,g={operatorsUrl:null,fieldsUrl:null,eventNamespace:"sulu.condition-selection",dataAttribute:"condition-selection",instanceName:"condition",translations:{addButton:"resource.filter.add-condition"},data:[],validationSelector:null},h={string:b,number:c,integer:c,"float":c,"boolean":e,date:d,datetime:d,tags:f},i={container:function(a,b){return['<div class="',a,'" id="',b,'" style="display:none"></div>'].join("")},button:function(a,b){return['<div class="grid-row">','   <div class="grid-col-3">','       <div id="',a,'" class="btn action">','           <span class="fa-plus-circle"></span>','           <span class="text">',b,"</span>","       </div>","   </div>","</div>"].join("")},row:function(a,b){return['<div class="',a,' grid-row" data-id="',b,'"></div>'].join("")},removeButton:function(a){return['<div class="grid-col-1 align-center pointer ',a,'">','<span class="fa-minus-circle m-top-7"></span>',"</div>"].join("")},input:function(a,b){return['<input data-validation-required="true" class="form-element husky-validate ',b,'" type="text" value="',a,'">'].join("")},col:function(a){return['<div class="',a,'"></div>'].join("")},select:function(a){return['<select data-validation-required="true" class="form-element husky-validate ',a,'"></select>'].join("")}},j={valueInputClass:"value-input",conditionContainerClass:"conditions-container",conditionRowClass:"condition-row",operatorSelectClass:"operator-select",fieldSelectClass:"field-select",removeButtonClass:"condition-remove"},k=function(){return n.call(this,"initialized")},l=function(){return"data-changed"},m=function(){return n.call(this,"data-changed")},n=function(a){return this.options.eventNamespace+"."+(this.options.instanceName?this.options.instanceName+".":"")+a},o=function(){var a=this.sandbox.dom.createElement('<div id="'+this.options.ids.loader+'"></div>');this.sandbox.dom.append(this.options.el,a),this.sandbox.start([{name:"loader@husky",options:{el:a,size:"100px",color:"#cccccc"}}])},p=function(){this.sandbox.stop("#"+this.options.ids.loader)},q=function(){this.options.data&&this.options.data.length>0&&this.options.data.forEach(function(a){r.call(this,a)}.bind(this))},r=function(a){var b,c,d,e,f,g,h={},k=[],l=a?a.id:"new";b=this.sandbox.dom.createElement(i.row(j.conditionRowClass,l)),c=this.sandbox.dom.createElement(i.removeButton(j.removeButtonClass)),a?(h=a.conditions[0],k=G.call(this,h.type),d=x.call(this,h.field,!1,!0)):d=x.call(this,h.field,!0,!0),f=A.call(this,h.operator,h.type),e=s.call(this,f,k,!1,!0),g=y.call(this,a,f,"grid-col-4",!0),this.sandbox.dom.append(b,c),this.sandbox.dom.append(b,d),this.sandbox.dom.append(b,e),this.sandbox.dom.append(b,g),this.sandbox.dom.append(this.$container,b)},s=function(a,b,c,d){var e,f=J.call(this,a?a.id:null,"id","name",b,j.operatorSelectClass,c);return a&&this.sandbox.dom.data(f,"type",a.type),d?(e=this.sandbox.dom.createElement(i.col("grid-col-3")),this.sandbox.dom.append(e,f),e):f},t=function(a){var b;a&&(this.usedFields[a]?(b=this.usedFields[a],delete this.usedFields[a],this.fields[a]=b):this.sandbox.logger.error("Field "+a+" could not be found in used fields!"))},u=function(a){var b;this.fields[a]?(b=this.fields[a],delete this.fields[a],this.usedFields[a]=b):this.sandbox.logger.error("Field "+a+" could not be found in fields!")},v=function(a){var b=this.sandbox.dom.find("."+j.fieldSelectClass,this.$el);this.sandbox.util.foreach(b,function(b){b!==a&&w.call(this,b)}.bind(this))},w=function(a){var b,c=this.sandbox.dom.find("option",a),d=this.sandbox.dom.val(a),e=!1;this.sandbox.dom.val(c[0])||(e=!0),this.sandbox.dom.remove(c),c=K.call(this,d,"name","translation",this.fields,e),d&&(this.fields[d]||(b=this.sandbox.translate(this.usedFields[d].translation),c.push('<option value="'+this.usedFields[d].name+'" selected>'+b+"</option>")),this.sandbox.dom.append(a,c.join("")))},x=function(a,b,c){var d,e=J.call(this,a,"name","translation",this.fields,j.fieldSelectClass,b);return a&&(u.call(this,a),v.call(this,e[0]),this.sandbox.dom.data(e,"value",a)),c?(d=this.sandbox.dom.createElement(i.col("grid-col-4")),this.sandbox.dom.append(d,e),d):e},y=function(a,b,c,d){var e,f,g,h=null;return a&&b?a.conditions.length>1?this.sandbox.logger.error("Multiple conditions not yet supported!"):(f=a.conditions[0],h=B.call(this,b,f.value),g=f.id):h=!a&&b?B.call(this,b,""):F.call(this,"",j.valueInputClass),this.options.validationSelector&&this.sandbox.form.addField(this.options.validationSelector,h),this.sandbox.dom.data(h,"id",g),d?(e=this.sandbox.dom.createElement(i.col(c)),this.sandbox.dom.append(e,h),e):h},z=function(a){var b=null;return a=parseInt(a),this.operators.forEach(function(c){return c.id===a?(b=c,!1):void 0}.bind(this)),b},A=function(a,b){var c=null;return"string"==typeof b&&(b=I.call(this,b)),this.operators.forEach(function(d){return d.operator===a&&d.type===b?(c=d,!1):void 0}.bind(this)),c},B=function(a,b){switch(a.inputType){case"date":case"datepicker":return E.call(this,b,j.valueInputClass);case"select":case"boolean":case"radio":case"checkbox":return J.call(this,b,"value","name",a.values,j.valueInputClass,!0);case"":case"simple":return F.call(this,b,j.valueInputClass);default:return D.call(this,b,j.valueInputClass,a)}},C=function(a,b){switch(a.inputType||""){case"date":case"datepicker":return this.sandbox.dom.val(this.sandbox.dom.find("."+j.valueInputClass+" input",b));case"":case"select":case"boolean":case"radio":case"checkbox":case"simple":return this.sandbox.dom.val(this.sandbox.dom.find("."+j.valueInputClass,b));default:return $("."+j.valueInputClass,b).data("value")}},D=function(a,b,c){var d=$('<div class="'+b+'"/>');return this.sandbox.start([{name:"condition-selection/"+c.inputType+"@suluresource",options:{el:d,operator:c,value:a}}]),d},E=function(a,b){var c,d=this.sandbox.dom.createElement('<div data-value="'+a+'" class="'+b+'"></div>'),e=this.sandbox.data.deferred();return this.deferreds.push(e),c="cs-datepicker"+this.deferreds.length,this.sandbox.start([{name:"input@husky",options:{el:d,datepickerOptions:{endDate:new Date},skin:"date",value:a,instanceName:c}}]),this.sandbox.on("husky.input."+c+".initialized",function(){e.resolve()}.bind(this)),d},F=function(a,b){return this.sandbox.dom.createElement(i.input(a,b))},G=function(b){var c=[];return b="string"==typeof b?I.call(this,b):b||a,this.operators.forEach(function(a){a.type===b&&c.push(a)}.bind(this)),c},H=function(a){return h.hasOwnProperty(a)?!0:!1},I=function(a){return H(a)?h[a]:(this.sandbox.logger.error('Unsupported type "'+a+'" found!'),null)},J=function(a,b,c,d,e,f){var g=K.call(this,a,b,c,d,f),h=this.sandbox.dom.createElement(i.select.call(this,e));return this.options.validationSelector&&this.sandbox.form.addField(this.options.validationSelector,h),this.sandbox.dom.append(h,g.join("")),h},K=function(a,b,c,d,e){var f,g,h=[];e&&h.push('<option value=""></option>');for(f in d)d.hasOwnProperty(f)&&(g=this.sandbox.translate(d[f][c]),d[f][b]===a?h.push('<option value="'+d[f][b]+'" selected>'+g+"</option>"):h.push('<option value="'+d[f][b]+'">'+g+"</option>"));return h},L=function(){var a=this.sandbox.translate(this.options.translations.addButton),b=this.sandbox.dom.createElement(i.button.call(this,this.options.ids.addButton,a));this.sandbox.dom.append(this.options.el,b)},M=function(){this.sandbox.dom.on(this.options.el,"click",U.bind(this),"#"+this.options.ids.addButton),this.sandbox.dom.on(this.$container,"click",V.bind(this),"."+j.removeButtonClass),this.sandbox.dom.on(this.$container,"change",T.bind(this),"."+j.fieldSelectClass),this.sandbox.dom.on(this.$container,"change",S.bind(this),"."+j.operatorSelectClass),this.sandbox.dom.on(this.$el,l.call(this),Q.bind(this)),this.sandbox.dom.on(this.$container,"change",function(){Z.call(this)}.bind(this),"select, input, div"),this.sandbox.dom.on(this.$container,"change",function(a){O.call(this,a)}.bind(this),"select."+j.operatorSelectClass),this.sandbox.dom.on(this.$container,"change",N.bind(this),"select."+j.fieldSelectClass)},N=function(a){var b=this.sandbox.dom.createElement(a.currentTarget),c=this.sandbox.dom.data(b,"value"),d=this.sandbox.dom.val(b);c&&t.call(this,c),d&&(u.call(this,d),v.call(this,b[0]),this.sandbox.dom.data(b,"value",d))},O=function(a){var b=a.currentTarget,c=this.sandbox.dom.val(b),d=z.call(this,c);this.sandbox.dom.data(b,"type",d.type)},P=function(){for(var a in this.usedFields)this.fields[a]=this.usedFields[a];this.usedFields={}},Q=function(){var a=this.sandbox.dom.data(this.options.el,"condition-selection");P.call(this),R.call(this,a),Z.call(this)},R=function(a){var b=this.sandbox.dom.find("."+j.conditionRowClass,this.$container);this.sandbox.dom.each(b,function(a,b){W.call(this,b)}.bind(this)),this.options.data=a,q.call(this)},S=function(a){var b=a.target.value,c=this.sandbox.dom.closest(a.target,"."+j.conditionRowClass),d=z.call(this,b),e=this.sandbox.dom.find("."+j.valueInputClass,c)[0],f=this.sandbox.dom.parent(e);this.options.validationSelector&&this.sandbox.form.removeField(this.options.validationSelector,e),this.sandbox.stop(e),this.sandbox.dom.remove(e),e=y.call(this,null,d,null,!1),this.sandbox.dom.append(f,e)},T=function(a){var b=a.target.value,c=this.fields[b],d=G.call(this,c["filter:input-type"]),e=this.sandbox.dom.closest(a.target,"."+j.conditionRowClass),f=this.sandbox.dom.find("."+j.operatorSelectClass,e)[0],g=this.sandbox.dom.find("."+j.valueInputClass,e)[0],h=this.sandbox.dom.parent(f),i=this.sandbox.dom.parent(g);this.options.validationSelector&&(this.sandbox.form.removeField(this.options.validationSelector,g),this.sandbox.form.removeField(this.options.validationSelector,f)),this.sandbox.dom.remove(f),this.sandbox.stop(g),this.sandbox.dom.remove(g),f=s.call(this,null,d,!0,!1),g=y.call(this),this.sandbox.dom.append(h,f),this.sandbox.dom.append(i,g)},U=function(){r.call(this),this.sandbox.emit(m.call(this))},V=function(a){var b=this.sandbox.dom.closest(a.currentTarget,"."+j.conditionRowClass),c=this.sandbox.dom.find("."+j.fieldSelectClass,b),d=this.sandbox.dom.data(c,"value");t.call(this,d),v.call(this,c),W.call(this,b)},W=function(a){var b=(this.sandbox.dom.data(a,"id"),this.sandbox.dom.find("."+j.fieldSelectClass,a)),c=this.sandbox.dom.find("."+j.operatorSelectClass,a),d=this.sandbox.dom.find("."+j.valueInputClass,a);this.options.validationSelector&&(this.sandbox.form.removeField(this.options.validationSelector,b),this.sandbox.form.removeField(this.options.validationSelector,c),this.sandbox.form.removeField(this.options.validationSelector,d)),this.sandbox.dom.remove(a),Z.call(this)},X=function(a){var b,c,d,e,f,g,h,i={conditions:[]},k=this.sandbox.dom.data(a,"id");return k&&"new"!==k&&(i.id=k),b=this.sandbox.dom.val(this.sandbox.dom.find("."+j.fieldSelectClass,a)),d=this.sandbox.dom.data(this.sandbox.dom.find("."+j.operatorSelectClass,a),"type"),c=this.sandbox.dom.val(this.sandbox.dom.find("."+j.operatorSelectClass,a)),f=this.sandbox.dom.data(this.sandbox.dom.find("."+j.valueInputClass,a),"id"),h=z.call(this,c),e=C.call(this,h||{},a),g={type:d,field:b,operator:h?h.operator:null,value:e},f&&(g.id=f),i.conditions.push(g),i},Y=function(){var a=[],b=this.sandbox.dom.find("."+j.conditionRowClass,this.$container);return this.sandbox.dom.each(b,function(b,c){a.push(X.call(this,c))}.bind(this)),a},Z=function(){this.data=Y.call(this),this.sandbox.dom.data(this.options.el,"conditionSelection",this.data),this.sandbox.emit(m.call(this))},_=function(a){var b={};return a.forEach(function(a){H(a["filter:input-type"])&&(b[a.name]=a)}.bind(this)),b};return{initialize:function(){this.options=this.sandbox.util.extend(!0,{},g,this.options),this.options.ids={loader:"condition-selection-"+this.options.instanceName+"-loader",container:"condition-selection-"+this.options.instanceName+"-container",addButton:"condition-selection-"+this.options.instanceName+"-add-button"},o.call(this),this.fetchOperatorsAndFields()},fetchOperatorsAndFields:function(){var a,b;this.options.operatorsUrl&&"string"==typeof this.options.operatorsUrl&&this.options.fieldsUrl&&"string"==typeof this.options.fieldsUrl?(a=this.sandbox.util.load(this.options.operatorsUrl),b=this.sandbox.util.load(this.options.fieldsUrl),this.sandbox.data.when(a,b).done(function(a,b){this.operators=a[0]._embedded.items,this.fields=_.call(this,b[0]),this.render()}.bind(this))):this.sandbox.logger.error("Url for fields and/or operators not specified or invalid!")},render:function(){this.usedFields={},this.deferreds=[],this.$container=this.sandbox.dom.createElement(i.container(j.conditionContainerClass,this.options.ids.container)),this.sandbox.dom.append(this.options.el,this.$container),this.options.data&&q.call(this),L.call(this),p.call(this),this.sandbox.dom.show(this.$container),this.deferreds?this.sandbox.data.when.apply(this,this.deferreds).then(function(){M.call(this)}.bind(this)):M.call(this),this.sandbox.emit(k.call(this))}}});