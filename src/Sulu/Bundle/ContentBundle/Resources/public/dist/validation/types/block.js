define(["type/default","app-config"],function(a,b){"use strict";var c=function(a,b,c){a.find(".type-select").parent().removeClass("hidden"),Husky.start([{name:"select@husky",options:{el:a.find(".type-select"),instanceName:"change"+b.index,valueName:"title",selectCallback:c,data:this.types,defaultLabel:$.grep(this.types,function(a){return a.id===b.type})[0].title}}])};return function(d,e,f){var g={},h={initializeSub:function(){var a,b,c,d=[];for(this.templates={},a=0,b=this.options.config.length;b>a;a++)c=this.options.config[a],this.templates[c.data]=App.dom.find("#"+c.tpl,this.$el).html(),c.id=c.data,c.name=App.translate(c.title),d.push(c);this.id=this.$el.attr("id"),this.propertyName=App.dom.data(this.$el,"mapperProperty"),this.types=d,this.$addButton=$("#"+this.id+"-add"),this.getMinOccurs()!==this.getMaxOccurs()?this.initSelectComponent(d):App.dom.remove(this.$addButton),this.bindDomEvents(),this.checkSortable(),this.setValue([])},getChildren:function(){return this.$el.children()},getMinOccurs:function(){return this.options.min},getMaxOccurs:function(){return this.options.max},canAdd:function(){var a=this.getChildren().length;return null===this.getMaxOccurs()||a<this.getMaxOccurs()},canRemove:function(){var a=this.getChildren().length;return a>this.getMinOccurs()},initSelectComponent:function(a){App.start([{name:"select@husky",options:{el:this.$addButton,instanceName:this.id,defaultLabel:App.translate("sulu.content.add-type"),fixedLabel:!0,style:"action",icon:"plus-circle",data:a.length>1?a:[],repeatSelect:!0,selectCallback:function(a){this.addChild(a,{},!0)}.bind(this),deselectCallback:function(a){this.addChild(a,{},!0)}.bind(this),noItemsCallback:function(){this.addChild(this.types[0].data,{},!0)}.bind(this)}}])},bindDomEvents:function(){this.$el.on("click",'*[data-mapper-remove="'+this.propertyName+'"]',this.removeBlockHandler.bind(this)),$("#sort-text-blocks-"+this.id).on("click",this.showSortMode.bind(this)),$("#edit-text-blocks-"+this.id).on("click",this.showEditMode.bind(this))},removeBlockHandler:function(a){var b=function(){var b=$(a.target),c=b.closest("."+this.propertyName+"-element");this.canRemove()&&(this.form.removeFields(c),c.remove(),$(f.$el).trigger("form-remove",[this.propertyName]),this.checkFullAndEmpty())}.bind(this);Husky.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","sulu.overlay.delete-desc",null,b)},checkSortable:function(){this.getChildren().length<=1?this.setSortable(!1):this.setSortable(!0)},validate:function(){return!0},addChild:function(a,b,d,e){var g,h,i,j=App.data.deferred();return("undefined"==typeof e||null===e)&&(e=this.getChildren().length),this.templates.hasOwnProperty(a)||(a=this.options["default"]),this.canAdd()?(App.dom.remove(App.dom.find("> *:nth-child("+(e+1)+")",this.$el)),b.type=a,g=$.extend({},{index:e,translate:App.translate,type:a},b),h=_.template(this.templates[a],g,f.options.delimiter),i=$(h),App.dom.insertAt(e,"> *",this.$el,i),this.types.length>1&&c.call(this,i,g,function(a){var b=f.mapper.getData(i);Husky.stop(i.find("*")),this.addChild(a,b,!0,i.index())}.bind(this)),this.getMinOccurs()===this.getMaxOccurs()&&App.dom.remove(App.dom.find(".options-remove",i)),f.initFields(i).then(function(){f.mapper.setData(b,i).then(function(){j.resolve(),d&&$(f.$el).trigger("form-add",[this.propertyName,b,e])}.bind(this))}.bind(this)),this.checkFullAndEmpty()):j.resolve(),j.promise()},checkFullAndEmpty:function(){this.$addButton.removeClass("empty"),this.$addButton.removeClass("full"),this.$el.removeClass("empty"),this.$el.removeClass("full"),this.canAdd()?this.canRemove()||(this.$addButton.addClass("empty"),this.$el.addClass("empty")):(this.$addButton.addClass("full"),this.$el.addClass("full")),this.getChildren().size()<=1?$("#text-block-header-"+this.id).hide():$("#text-block-header-"+this.id).show()},internalSetValue:function(a){var b,c,d,e,f=App.data.deferred(),g=function(){d--,0>=d&&f.resolve()};if(this.form.removeFields(this.$el),App.dom.children(this.$el).remove(),c=a.length<this.getMinOccurs()?this.getMinOccurs():a.length,d=c,c>0)for(b=0;c>b;b++)e=a[b]||{},this.addChild(e.type||this.options["default"],e).then(function(){g()});else g();return f.promise()},setValue:function(a){"object"!=typeof a||App.dom.isArray(a)||(a=[a]);var b=this.internalSetValue(a);return b.then(function(){App.logger.log("resolved block set value")}),b},getValue:function(){var a=[];return App.dom.children(this.$el).each(function(){a.push(f.mapper.getData($(this)))}),a},iterateBlockFields:function(a,b){a.size()&&$.each(a,function(a,c){var d=$(c),e=d.find("[data-mapper-property]");e.size()&&$.each(e,function(a,c){var e=$(c),f=e.data("property")||{};f.tags||[];(b||$.noop)(e,d)})})},showSortMode:function(){var a=this.getChildren(),c=b.getSection("sulu-content");$("#sort-text-blocks-"+this.id).addClass("hidden"),$("#edit-text-blocks-"+this.id).removeClass("hidden"),this.$el.addClass("is-sortmode"),this.iterateBlockFields(a,function(a,b){var d=a.data("property")||{},e=d.tags||[];"textEditor"===a.data("type")&&App.emit("husky.ckeditor."+a.data("aura-instance-name")+".destroy"),e.length&&_.where(e,{name:c.showInSortModeTag}).length&&this.showSortModeField(a,b)}.bind(this)),this.checkSortable()},showSortModeField:function(a,b){var c=a.data("element").getValue(),d=a.attr("id"),e=$('[data-sort-mode-id="'+d+'"]',b);e.size()&&e.html(!!c&&c.replace(/<(?:.|\n)*?>/gm,"")).addClass("show-in-sortmode")},showEditMode:function(){var a=this.getChildren();App.dom.removeClass("#sort-text-blocks-"+this.id,"hidden"),App.dom.addClass("#edit-text-blocks-"+this.id,"hidden"),this.$el.removeClass("is-sortmode"),this.iterateBlockFields(a,function(a,b){a.removeClass("show-in-sortmode"),"textEditor"===a.data("type")&&App.emit("husky.ckeditor."+a.data("aura-instance-name")+".start")}.bind(this))},setSortable:function(a){a?App.dom.hasClass(this.$el,"sortable")||App.dom.addClass(this.$el,"sortable"):(App.dom.removeClass(this.$el,"sortable"),App.dom.sortable(this.$el,"destroy")),$(f.$el).trigger("init-sortable")}};return new a(d,g,e,"block",h,f)}});