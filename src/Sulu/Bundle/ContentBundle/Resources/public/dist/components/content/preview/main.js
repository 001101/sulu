define(["app-config","websocket-manager"],function(a,b){"use strict";return function(){var c={initiated:!1,init:function(a){var b=this.sandbox.data.deferred();return c.initiated||(this.sandbox.dom.on(this.$el,"focusout",i.bind(this),".preview-update"),this.sandbox.dom.on(this.$el,"change",i.bind(this),'input[type="checkbox"].preview-update, input[type="radio"].preview-update'),c.start.call(this,b,a),c.initiated=!0),b},update:function(a){var b="/admin/content/preview/"+this.data.id+"/update?webspace="+this.options.webspace+"&language="+this.options.language;this.sandbox.util.ajax({url:b,type:"POST",data:{changes:a}})},start:function(a,b){var c="/admin/content/preview/"+this.data.id+"/start?webspace="+this.options.webspace+"&language="+this.options.language;this.sandbox.util.ajax({url:c,type:"POST",data:{data:this.data,template:b},success:function(){a.resolve()}})},stop:function(a){var b="/admin/content/preview/"+this.data.id+"/stop?webspace="+this.options.webspace+"&language="+this.options.language;this.sandbox.util.ajax({url:b,type:"GET",success:function(){a.resolve()}})}},d={detection:function(){var a="MozWebSocket"in window?"MozWebSocket":"WebSocket"in window?"WebSocket":null;return null===a?(this.sandbox.logger.log("Your browser doesn't support Websockets."),!1):(window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),!0)},init:function(a){var e=this.sandbox.data.deferred();return this.sandbox.logger.log("Connect to url: "+url),d.socket=b.getClient("sulu_content.preview"),d.socket.onopen=function(){this.sandbox.logger.log("Connection established!"),this.opened=!0,this.sandbox.dom.on(this.formId,"keyup change",i.bind(this),".preview-update"),d.start.call(this,e,a),e.resolve()}.bind(this),d.socket.onclose=function(){this.opened||(this.method="ajax",c.init.call(this,a).then(function(){e.resolve()}.bind(this)))}.bind(this),d.socket.onmessage=function(a){var b=JSON.parse(a.data);this.sandbox.logger.log("Message:",b),"start"===b.command&&"OK"===b.message&&this.def&&(this.def.resolve(),this.def=null)}.bind(this),d.socket.onerror=function(b){this.sandbox.logger.warn(b),this.method="ajax",c.init.call(this,a).then(function(){e.resolve()}.bind(this))}.bind(this),e},update:function(b){if("ws"===this.method&&d.socket.readyState===d.socket.OPEN){var c={command:"update",content:this.data.id,type:"form",user:a.getUser().id,webspaceKey:this.options.webspace,languageCode:this.options.language,changes:b};d.socket.send(JSON.stringify(c))}},start:function(b,c){if("ws"===this.method){this.def=b;var e={command:"start",content:this.data.id,type:"form",user:a.getUser().id,webspaceKey:this.options.webspace,languageCode:this.options.language,data:this.data,template:c};d.socket.send(JSON.stringify(e))}},stop:function(b){if("ws"===this.method){var c={command:"stop",content:this.data.id,type:"form",user:a.getUser().id,webspaceKey:this.options.webspace,languageCode:this.options.language};d.socket.send(JSON.stringify(c)),b.resolve()}}},e=function(a){var b;if(!this.initiated)return b=d.detection()?d.init.call(this,a):c.init.call(this,a),this.initiated=!0,b.promise()},f=function(){var a=this.sandbox.data.deferred();return this.initiated&&("ws"===this.method?d.stop.call(this,a):c.stop.call(this,a)),a},g=function(a,b){if(this.initiated){var e={};if(a)e[a]=b;else{if(!this.sandbox.form.getObject(this.formId))return;e=this.sandbox.form.getData(this.formId)}"ws"===this.method?d.update.call(this,e):c.update.call(this,e)}},h=function(){if(this.initiated){var a={};"ws"===this.method?d.update.call(this,a):c.update.call(this,a)}},i=function(a){if(this.data.id&&this.initiated){var b=$(a.currentTarget),c=this.sandbox.dom.data(b,"element"),d=this.getSequence(b);d&&g.call(this,d,c.getValue())}},j=function(){this.sandbox.on("sulu.preview.update-property",function(a,b){g.call(this,a,b)}.bind(this)),this.sandbox.on("sulu.preview.update-only",function(){h.call(this)}.bind(this)),this.sandbox.on("sulu.preview.update",function(a,b,c){if(this.data.id){var d=this.getSequence(a);"ws"!==this.method&&c||g.call(this,d,b)}},this)};return{sandbox:null,options:null,data:null,$el:null,initiated:!1,opened:!1,method:"ws",formId:"#content-form",initialize:function(a,b,c){this.sandbox=a,this.options=b,this.$el=c},start:function(a,b){this.data=a,this.options=b,e.call(this).then(function(){j.call(this),this.sandbox.emit("sulu.preview.initiated")}.bind(this))},restart:function(a,b,d){this.options=b,f.call(this).then(function(){this.data=a,this.initiated=!1,this.opened=!1,this.method="ws",c.initiated=!1,e.call(this,d).then(function(){this.sandbox.emit("sulu.preview.initiated")}.bind(this))}.bind(this))},getSequence:function(a,b){this.sandbox&&(b=this.sandbox),a=$(a);for(var c,d=b.dom.data(a,"mapperProperty"),e=a.parents("*[data-mapper-property]"),f=a.parents("*[data-mapper-property-tpl]")[0];!a.data("element");){if(0===a.length)return!1;a=a.parent()}return e.length>0&&(c=b.dom.data(e[0],"mapperProperty"),"string"!=typeof c&&(c=b.dom.data(e[0],"mapperProperty")[0].data),d=[c,$(f).index(),b.dom.data(a,"mapperProperty")]),d}}}});