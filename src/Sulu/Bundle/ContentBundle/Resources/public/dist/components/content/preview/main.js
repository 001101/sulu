define(["app-config","websocket-manager"],function(a,b){"use strict";var c="admin",d="sulu_content.preview";return function(){var e=function(b){if(!this.initiated){var c=this.client.send(d,{command:"start",content:this.options.id,locale:this.options.language,webspaceKey:this.options.webspace,template:b,data:this.data,user:a.getUser().id});return this.initiated=!0,c.promise()}},f=function(){var b;return this.initiated&&(b=this.client.send(d,{command:"stop",user:a.getUser().id}),this.initiated=!1),b.promise()},g=function(a,b){if(this.initiated){var c,e={};if(a)e[a]=b;else{if(!this.sandbox.form.getObject(this.formId))return;e=this.sandbox.form.getData(this.formId)}return c=this.client.send(d,{command:"update",data:e}),c.then(i.bind(this)),c.promise()}},h=function(){if(this.initiated){var a={};return this.client.send(d,{command:"update",data:a})}},i=function(a,b){this.sandbox.emit("sulu.preview.changes",b.data)},j=function(a){if(this.data.id&&this.initiated){var b=$(a.currentTarget),c=this.sandbox.dom.data(b,"element"),d=this.getSequence(b);d&&g.call(this,d,c.getValue())}},k=function(){this.sandbox.on("sulu.preview.update-property",function(a,b){g.call(this,a,b)}.bind(this)),this.sandbox.on("sulu.preview.update-only",function(){h.call(this)}.bind(this)),this.sandbox.on("sulu.preview.update",function(a,b,c){if(this.data.id){var d=this.getSequence(a);"ws"!==this.method&&c||g.call(this,d,b)}},this),"WEBSOCKET"===this.client.getType()?this.sandbox.dom.on(this.formId,"keyup change",j.bind(this),".preview-update"):(this.sandbox.dom.on(this.$el,"focusout",j.bind(this),".preview-update"),this.sandbox.dom.on(this.$el,"change",j.bind(this),'input[type="checkbox"].preview-update, input[type="radio"].preview-update'))};return{sandbox:null,options:null,data:null,$el:null,initiated:!1,formId:"#content-form",initialize:function(a,d,e){this.sandbox=a,this.options=d,this.$el=e,this.client=b.getClient(c)},start:function(a,b){this.data=a,this.options=b,e.call(this).then(function(){k.call(this),this.sandbox.emit("sulu.preview.initiated")}.bind(this))},restart:function(a,b,c){this.options=b,f.call(this).then(function(){e.call(this,c).then(function(){this.sandbox.emit("sulu.preview.initiated")}.bind(this))}.bind(this))},getSequence:function(a,b){this.sandbox&&(b=this.sandbox),a=$(a);for(var c,d=b.dom.data(a,"mapperProperty"),e=a.parents("*[data-mapper-property]"),f=a.parents("*[data-mapper-property-tpl]")[0];!a.data("element");){if(0===a.length)return!1;a=a.parent()}return e.length>0&&(c=b.dom.data(e[0],"mapperProperty"),"string"!=typeof c&&(c=b.dom.data(e[0],"mapperProperty")[0].data),d=[c,$(f).index(),b.dom.data(a,"mapperProperty")]),d},setContext:function(a,b){this.document=a,this.location=b}}}});